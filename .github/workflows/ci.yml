name: Auto-Build Docker Images For Subfolders

on:
  push:
    branches:
      - '**'
    tags:
      - 'v*.*.*'

jobs:
  discover-dockerfiles:
    runs-on: ubuntu-latest
    outputs:
        dockerfiles: ${{ steps.find.outputs.dockerfiles }}
    steps:
      - uses: actions/checkout@v4

      - id: find
        run: |
          # Find all Dockerfiles except root-level one
          FILES=$(find . -type f -name Dockerfile | grep -v '^./Dockerfile$' || true)

          # Convert to compact JSON array: ["a","b"]
          JSON=$(printf '%s\n' $FILES | jq -R . | jq -s -c .)

          # Write clean JSON to GitHub output
          echo "dockerfiles=$JSON" >> $GITHUB_OUTPUT

  changed-dockerfiles:
    runs-on: ubuntu-latest
    needs: discover-dockerfiles
    outputs:
      changed: ${{ steps.filter.outputs.changed }}
    steps:
      - uses: actions/checkout@v4

      - id: filter
        run: |
          CHANGED="[]"

          for df in $(echo '${{ needs.discover-dockerfiles.outputs.dockerfiles }}' | jq -r '.[]'); do
            DIR=$(dirname "$df")

            # SAFE git diff (works even if no HEAD~1 exists)
            if git rev-parse HEAD~1 >/dev/null 2>&1; then
              git diff --quiet HEAD~1 HEAD -- "$DIR"
              DIFF_EXIT=$?
            else
              DIFF_EXIT=1
            fi

            # If no changes, skip
            if [ $DIFF_EXIT -eq 0 ]; then
              continue
            fi

            # Add to changed array
            CHANGED=$(echo "$CHANGED" | jq --arg d "$df" '. + [$d]')
          done

          # Compact JSON (must be 1 line!)
          CHANGED_COMPACT=$(echo "$CHANGED" | jq -c .)

          echo "changed=$CHANGED_COMPACT" >> $GITHUB_OUTPUT

  prepare-build:
    needs: changed-dockerfiles
    if: ${{ needs.changed-dockerfiles.outputs.changed != '[]' }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        dockerfile: ${{ fromJson(needs.changed-dockerfiles.outputs.changed) }}
    outputs:
      image_name: ${{ steps.out.outputs.image_name }}
      dockerfile_path: ${{ matrix.dockerfile }}

    steps:
      - id: out
        run: |
          DF="${{ matrix.dockerfile }}"
          FOLDER=$(dirname "$DF" | sed 's|^\./||')
          IMAGE="python/$FOLDER"
          echo "image_name=$IMAGE" >> $GITHUB_OUTPUT

  build-images:
    needs: prepare-build
    uses: hitesha1981/ci-templates/.github/workflows/dockerfiles.yml@main
    with:
      image_name: ${{ needs.prepare-build.outputs.image_name }}
      dockerfile_path: ${{ needs.prepare-build.outputs.dockerfile_path }}
    secrets:
      GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
